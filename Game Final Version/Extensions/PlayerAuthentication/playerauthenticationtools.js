var gdjs;(function(d){const a=new d.Logger("Player Authentication"),u=d.playerAuthenticationComponents;let Q;(function(r){let w=null,A=null,p=null,M=!1,b=!1,D=null,y=null,k=null,W=null,f=null,l=null,j=null,x=null,I=null,v=null,g=null;const X=e=>{F(e)==="web"&&($(),I=t=>{_({runtimeScene:e,event:t,checkOrigin:!0})},window.addEventListener("message",I,!0),a.info("Notifying parent window that player authentication is ready."),window.parent.postMessage({id:"playerAuthReady"},"*"),j=setTimeout(()=>{a.info("Removing automatic games platform authentication listener."),$()},3e3))},Y=e=>{const t=e.getGame().getAdditionalOptions();if(t&&t.isPreview){const n=t.playerId,o=t.playerToken,i=t.playerUsername;n&&o&&(a.info(`Automatically logging in the player with ID ${n} as it's a preview.`),S({userId:n,username:i||null,userToken:o}),K(e))}};d.registerRuntimeScenePostEventsCallback(()=>{M=!1}),d.registerFirstRuntimeSceneLoadedCallback(e=>{Y(e),X(e)});const O=e=>`${e}_authenticatedUser`,U=({runtimeGame:e,gameId:t,connectionId:n})=>`https://gd.games/auth?gameId=${t}${n?`&connectionId=${n}`:""}${e.isUsingGDevelopDevelopmentEnvironment()?"&dev=true":""}&allowLoginProviders=true`,F=e=>e.getGame().getRenderer().getElectron()?"electron":Z(e)?"web-iframe":typeof cordova!="undefined"?"cordova-websocket":"web",Z=e=>{const t=e.getGame().getAdditionalOptions();return t&&t.isPreview&&t.allowAuthenticationUsingIframeForPreview};r.isAuthenticated=()=>(b||R(),p!==null),r.hasLoggedIn=()=>M,r.getUsername=()=>(b||R(),w||""),r.getUserToken=()=>(b||R(),p||null),r.getUserId=()=>(b||R(),A||"");const B=(e,t,n=0)=>{const i=`${e.isUsingGDevelopDevelopmentEnvironment()?"https://api-dev.gdevelop.io":"https://api.gdevelop.io"}/game/public-game/${t}`;return fetch(i,{method:"HEAD"}).then(s=>s.status!==200?(a.warn(`Error while fetching the game: ${s.status} ${s.statusText}`),s.status===404||n>2?!1:B(e,t,n+1)):!0,s=>(a.error("Error while fetching game:",s),!1))};r.logout=e=>{w=null,p=null,A=null;const t=d.projectData.properties.projectUuid;if(!t){a.error("Missing game id in project properties.");return}window.localStorage.removeItem(O(t)),G(e),r.removeAuthenticationBanner(e);const n=e.getGame().getRenderer().getDomElementContainer();if(!n){h(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}u.displayLoggedOutNotification(n)};const R=()=>{const e=d.projectData.properties.projectUuid;if(!e){a.error("Missing game id in project properties.");return}try{const t=window.localStorage.getItem(O(e));if(!t){b=!0;return}const n=JSON.parse(t);w=n.username,A=n.userId,p=n.userToken,b=!0}catch(t){a.warn("Unable to read authentication details from localStorage. Player authentication will not be available.",t)}},G=e=>{if(r.removeAuthenticationContainer(e),J(),g&&(a.info("Closing authentication websocket connection."),g.close(),g=null),D&&(D.close(),D=null),typeof SafariViewController!="undefined")try{SafariViewController.hide()}catch{a.info("Could not hide login window. Waiting for user to do it.")}},S=({username:e,userId:t,userToken:n})=>{e||a.warn("The authenticated player does not have a username"),w=e,A=t,p=n,M=!0;const o=d.projectData.properties.projectUuid;if(!o){a.error("Missing game id in project properties.");return}try{window.localStorage.setItem(O(o),JSON.stringify({username:w,userId:A,userToken:p}))}catch(i){a.warn("Unable to save the authentication details to localStorage. Player authentication will not be available.",i)}};r.login=({runtimeScene:e,userId:t,username:n,userToken:o})=>{S({userId:t,username:n,userToken:o}),G(e),r.removeAuthenticationBanner(e);const i=e.getGame().getRenderer().getDomElementContainer();if(!i){h(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}u.displayLoggedInNotification(i,w||"Anonymous")};const _=function({runtimeScene:e,event:t,checkOrigin:n,onDone:o}){if(!(n&&!["https://liluo.io","https://gd.games"].includes(t.origin))){if(!t.data.id)throw new Error("Malformed message");switch(t.data.id){case"authenticationResult":{if(!(t.data.body&&t.data.body.token))throw new Error("Malformed message.");r.login({runtimeScene:e,userId:t.data.body.userId,username:t.data.body.username,userToken:t.data.body.token}),P(e),o&&o("logged");break}case"alreadyAuthenticated":{if(!(t.data.body&&t.data.body.token))throw new Error("Malformed message.");S({userId:t.data.body.userId,username:t.data.body.username,userToken:t.data.body.token}),$(),K(e);break}}}},h=function(e,t){a.error(t),G(e);const n=e.getGame().getRenderer().getDomElementContainer();if(!n){h(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}u.displayErrorNotification(n),P(e)},ee=e=>{J();const t=15*60*1e3;x=setTimeout(()=>{a.info("Authentication window did not send message in time. Closing it."),G(e),P(e)},t)},J=()=>{x&&clearTimeout(x)},V=function(e){const t=()=>{r.removeAuthenticationBanner(e)},n=()=>{r.openAuthenticationWindow(e)};return p?u.computeAuthenticatedBanner(n,t,w):u.computeNotAuthenticatedBanner(n,t)};r.displayAuthenticationBanner=function(e){if(l){l.style.opacity="1";return}b||R();const t=e.getGame().getRenderer().getDomElementContainer();if(!t){h(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}l=V(e),t.appendChild(l)};const K=function(e){if(!l)return;const t=e.getGame().getRenderer().getDomElementContainer();if(!t){h(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}const n=l;l=V(e),t.replaceChild(l,n)},q=(e,t,n)=>new Promise(o=>{let i=!1;const s=e.getGame().isUsingGDevelopDevelopmentEnvironment()?`wss://api-ws-dev.gdevelop.io/play?gameId=${t}&connectionType=login`:`wss://api-ws.gdevelop.io/play?gameId=${t}&connectionType=login`;g=new WebSocket(s),g.onopen=()=>{a.info("Opened authentication websocket connection."),g&&g.send(JSON.stringify({action:"getConnectionId"}))},g.onerror=()=>{a.info("Error in authentication websocket connection."),i||(i=!0,o("errored")),h(e,"Error while connecting to the authentication server.")},g.onclose=()=>{a.info("Closing authentication websocket connection."),i||(i=!0,o("dismissed"))},g.onmessage=c=>{if(c.data){const C=JSON.parse(c.data);switch(C.type){case"authenticationResult":{const m=C.data;r.login({runtimeScene:e,userId:m.userId,username:m.username,userToken:m.token}),P(e),i=!0,o("logged");break}case"connectionId":{const E=C.data.connectionId;if(!E){a.error("No WebSocket connectionId received"),i=!0,o("errored");return}a.info("WebSocket connectionId received."),n({connectionId:E,resolve:o});break}}}}}),ne=(e,t)=>q(e,t,({connectionId:n})=>{const o=U({runtimeGame:e.getGame(),gameId:t,connectionId:n}),i=e.getGame().getRenderer().getElectron(),s=()=>i.shell.openExternal(o);s(),f&&u.addAuthenticationUrlToTextsContainer(s,f)}),oe=(e,t)=>q(e,t,({connectionId:n,resolve:o})=>{const i=U({runtimeGame:e.getGame(),gameId:t,connectionId:n});SafariViewController.isAvailable(function(s){s?SafariViewController.show({url:i,hidden:!1,animated:!0,transition:"slide",enterReaderModeIfAvailable:!1,barColor:"#000000",tintColor:"#ffffff",controlTintColor:"#ffffff"},function(c){c.event==="closed"&&o("dismissed")},function(c){a.log("Error opening webview: "+JSON.stringify(c)),o("errored")}):(a.error("Plugin SafariViewController is not available"),o("errored"))})}),ie=(e,t)=>new Promise(n=>{const o=U({runtimeGame:e.getGame(),gameId:t});let i=!1;v=E=>{_({runtimeScene:e,event:E,checkOrigin:!0,onDone:L=>{i||(i=!0,n(L))}})},window.addEventListener("message",v,!0);const s=screen.width/2-500/2,c=screen.height/2-600/2,C=`left=${s},top=${c},width=500,height=600`,m=()=>{D=window.open(o,"authentication",C)};m(),f&&u.addAuthenticationUrlToTextsContainer(m,f)}),ae=(e,t)=>new Promise(n=>{if(!W||!k||!f){a.error("Can't open an authentication iframe - no iframe container, loader container or text container was opened for it.");return}const o=U({runtimeGame:e.getGame(),gameId:t});v=i=>{_({runtimeScene:e,event:i,checkOrigin:!0,onDone:n})},window.addEventListener("message",v,!0),u.displayIframeInsideAuthenticationContainer(W,k,f,o)});r.openAuthenticationWindow=e=>new d.PromiseTask(new Promise(t=>{const n=e.getGame().getRenderer().getDomElementContainer();if(!n){h(e,"The div element covering the game couldn't be found, the authentication window cannot be displayed."),t({status:"errored"});return}const o=d.projectData.properties.projectUuid;if(!o){h(e,"The game ID is missing, the authentication window cannot be opened."),t({status:"errored"});return}let i=!1;const s=()=>{G(e),r.displayAuthenticationBanner(e),i=!0,t({status:"dismissed"})};l&&(l.style.opacity="0");const c=F(e),{rootContainer:C,loaderContainer:m,iframeContainer:E}=u.computeAuthenticationContainer(s);y=C,k=m,W=E,n.appendChild(y),(async()=>{const L=await B(e.getGame(),o);if(k){const z=e.getGame().getRenderer().getElectron(),de=z?()=>z.shell.openExternal("https://wiki.gdevelop.io/gdevelop5/publishing/web"):null;f=u.addAuthenticationTextsToLoadingContainer(k,c,L,de)}if(!L)return;ee(e);let T;switch(c){case"electron":T=await ne(e,o);break;case"cordova-websocket":T=await oe(e,o);break;case"web-iframe":T=await ae(e,o);break;case"web":default:T=await ie(e,o);break}i||(T==="dismissed"&&s(),t({status:T}))})()})),r.isAuthenticationWindowOpen=function(){return!!y},r.removeAuthenticationContainer=function(e){le();const t=e.getGame().getRenderer().getDomElementContainer();if(!t){a.info("The div element covering the game couldn't be found, the authentication must be already closed.");return}y&&t.removeChild(y),y=null,k=null,W=null,f=null};const le=function(){v&&(window.removeEventListener("message",v,!0),v=null)},$=function(){I&&(window.removeEventListener("message",I,!0),I=null),j&&(clearTimeout(j),j=null)};r.removeAuthenticationBanner=function(e){if(!l){a.info("The authentication banner couldn't be found, the authentication banner must be already closed.");return}const t=e.getGame().getRenderer().getDomElementContainer();if(!t){a.info("The div element covering the game couldn't be found, the authentication must be already closed.");return}t.removeChild(l),l=null};const P=function(e){const t=e.getGame().getRenderer().getCanvas();t&&t.focus()}})(Q=d.playerAuthentication||(d.playerAuthentication={}))})(gdjs||(gdjs={}));
//# sourceMappingURL=playerauthenticationtools.js.map
